{% extends "base.html" %}

{% block title %}WQI Dashboard â€” Monthly Forecast{% endblock %}

{% block page_specific_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<style>
    /* Water-specific color theme */
    :root { --accent: #3498db; --accent-glow: rgba(52, 152, 219, 0.15); }
    .section-title::before { background: linear-gradient(135deg, var(--accent), #2980b9); }
</style>
{% endblock %}

{% block content %}
<header>
    <h1>ðŸŒŠ WQI Dashboard â€” Monthly Forecast</h1>
</header>

<div class="container">
    <div class="card">
        <div class="section-title">Water Quality Map (Predicted WQI)</div>
        <div class="map-wrap">{{ map_html|safe }}</div>
        <div class="controls">
            <div class="legend">
                 <span class="dot" style="background:var(--good)"></span> <span>Good</span>
                <span class="dot" style="background:var(--moderate)"></span> <span>Satisfactory</span>
                <span class="dot" style="background:var(--usg)"></span> <span>Poor</span>
                <span class="dot" style="background:var(--unhealthy)"></span> <span>Very Poor</span>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="controls">
            <label class="muted">Location:</label>
            <select id="locationSelect">
                {% for p in locations %}
                    <option value="{{ p.id }}" {% if p.full_name == default_location_name %}selected{% endif %}>{{ p.full_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="chart-container">
            <canvas id="wqiChart"></canvas>
        </div>
    </div>

    <div class="details-grid">
        <div class="card recommendations">
            <div class="section-title">Health Recommendations</div>
            <div id="recommendations-content">
                {% if initial_details and initial_details.recommendation and initial_details.recommendation.general %}
                    <h4>{{ initial_details.recommendation.general.title }}</h4>
                    <p>{{ initial_details.recommendation.general.advice }}</p>
                {% else %}
                    <p class="muted">No recommendations available.</p>
                {% endif %}
            </div>
        </div>
        <div class="card lime-explanation">
            <div class="section-title">LIME: Why this prediction?</div>
            <div id="lime-content">
                {% if initial_details and initial_details.lime_explanation %}
                    <ul>
                        {% for rule in initial_details.lime_explanation %}
                            <li>{{ rule[0] }}</li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="muted">No LIME explanation available.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="card">
        <div class="section-title">Current Predicted WQI</div>
        <div class="locations">
            {% for p in locations %}
                <div class="loc">
                    <div><strong>{{ p.full_name }}</strong></div>
                    <div class="muted">Lat: {{ "%.4f"|format(p.lat) }}, Lon: {{ "%.4f"|format(p.lon) }}</div>
                    <div>Predicted WQI: <strong>{{ "%.2f"|format(p.wqi) }}</strong> ({{ p.classification }})</div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block page_specific_js %}
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>

<script>
    const LOCATIONS_DATA = {{ locations|tojson }};
    const INITIAL_SERIES = {{ chart_series|tojson }};
    const INITIAL_DETAILS = {{ initial_details|tojson }};
    let wqiChart;

    console.log("Chart Series Data Received by Browser:", INITIAL_SERIES);


    function drawWqiChart(series, title) {
        if (!series || series.length === 0) return;
        const ctx = document.getElementById('wqiChart').getContext('2d');
        if (wqiChart) wqiChart.destroy();
        series.sort((a, b) => new Date(a.x) - new Date(b.x))

        wqiChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'WQI Score',
                    data: series, // âœ… Directly uses {x, y}
                    borderColor: 'var(--accent)',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                parsing: {
                    xAxisKey: 'x',
                    yAxisKey: 'y'
                },
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: title, color: '#f8fafc', font: { size: 16 } }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'month', tooltipFormat: 'MMM yyyy' },
                        ticks: { color: '#94a3b8' },
                        grid: { color: 'rgba(55, 65, 81, 0.3)' }
                    },
                    y: {
                        title: { display: true, text: 'WQI Score (0-100)', color: '#cbd5e1' },
                        ticks: { color: '#94a3b8' },
                        grid: { color: 'rgba(55, 65, 81, 0.3)' }
                    }
                }
            }
        });
    }

    function updateRecommendations(data) {
        const container = document.getElementById('recommendations-content');
        if (data && data.recommendation && data.recommendation.general) {
            let html = `<h4>${data.recommendation.general.title}</h4><p>${data.recommendation.general.advice}</p>`;
            if (data.recommendation.smart && data.recommendation.smart.length > 0) {
                html += `<h5>Key Factors:</h5><ul>${data.recommendation.smart.map(item => `<li>${item}</li>`).join('')}</ul>`;
            }
            if (data.recommendation.contextual && data.recommendation.contextual.length > 0) {
                html += `<h5>Context:</h5><ul>${data.recommendation.contextual.map(item => `<li>${item}</li>`).join('')}</ul>`;
            }
            container.innerHTML = html;
        } else {
            container.innerHTML = `<p class="muted">No recommendations available.</p>`;
        }
    }

    function updateLimeExplanation(data) {
        const container = document.getElementById('lime-content'); 
        container.innerHTML = '';
        if (data.lime_explanation?.length) {
            const ul = document.createElement('ul');
            data.lime_explanation.forEach(rule => {
                const li = document.createElement('li');
                li.textContent = rule[0];
                ul.appendChild(li);
            });
            container.appendChild(ul);
        } else {
            container.innerHTML = '<p class="muted">No LIME explanation available.</p>';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const locationSelect = document.getElementById('locationSelect');

        // Set the initial state when the page first loads
        if (INITIAL_DETAILS) {
            drawWqiChart(INITIAL_SERIES, "WQI Forecast â€” {{ default_location_name }}");
            updateRecommendations(INITIAL_DETAILS);
            updateLimeExplanation(INITIAL_DETAILS);
        }

        // Add the event listener for dropdown changes
        locationSelect.addEventListener("change", async (e) => {
            const id = e.target.value;
            try {
                const forecastRes = await fetch(`/api/wqi_forecast_series?id=${id}`);
                const forecastData = await forecastRes.json();
                if (forecastData.ok) {
                    drawWqiChart(forecastData.series, `WQI Forecast â€” ${forecastData.name}`);
                }
            } catch (error) { console.error("Error fetching forecast:", error); }

            try {
                const detailsRes = await fetch(`/api/wqi_location_details?id=${id}`);
                const detailsData = await detailsRes.json();
                if (detailsData.ok) {
                    updateRecommendations(detailsData);
                    updateLimeExplanation(detailsData);
                }
            } catch (error) { console.error("Error fetching details:", error); }
        });
    });
</script>
{% endblock %}
